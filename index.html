<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cobblemon Lucky Wheel</title>
    <style>
        /* ... (all previous CSS remains the same) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #eee;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #0f1419;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #1e2936;
        }

        .header {
            background: linear-gradient(135deg, #1e2936 0%, #2d3748 100%);
            color: #fff;
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #3d5a80;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding: 30px;
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }

        .wheel-type-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .wheel-type-btn {
            flex: 1;
            padding: 15px 30px;
            border: 2px solid #3d5a80;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #1a1f2e;
            color: #98c1d9;
        }

        .wheel-type-btn.active {
            background: linear-gradient(135deg, #3d5a80 0%, #5a7a9a 100%);
            color: white;
            border-color: #5a7a9a;
            box-shadow: 0 5px 15px rgba(61, 90, 128, 0.4);
        }

        .roulette-container {
            background: #1a1f2e;
            border: 2px solid #3d5a80;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .roulette-wrapper {
            position: relative;
            width: 100%;
            height: 220px;
            overflow: hidden;
            border: 3px solid #3d5a80;
            border-radius: 10px;
            background: #0f1419;
        }

        .roulette-selector {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #e63946 0%, #ff006e 100%);
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 20px rgba(230, 57, 70, 0.8);
        }

        .roulette-selector::before {
            content: '‚ñº';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: #e63946;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(230, 57, 70, 0.8);
        }

        .roulette-track {
            display: flex;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            height: 100%;
            align-items: center;
            position: relative;
        }

        .roulette-item {
            flex: 0 0 120px;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1e2936;
            border: 2px solid #3d5a80;
            border-radius: 8px;
            margin: 0 5px;
            padding: 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .roulette-item.shiny {
            background: linear-gradient(135deg, #ffd60a 0%, #ffb703 100%);
            border-color: #ffd60a;
            box-shadow: 0 0 20px rgba(255, 214, 10, 0.5);
        }

        .roulette-item.netherstar {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border-color: #4cc9f0;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
        }

        .roulette-item.ender {
            background: linear-gradient(135deg, #7209b7 0%, #3a0ca3 100%);
            border-color: #9d4edd;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
        }

        .roulette-item img {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
            margin-bottom: 8px;
        }

        .roulette-item-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #98c1d9;
            text-align: center;
            word-wrap: break-word;
            max-width: 100%;
        }

        .roulette-item.shiny .roulette-item-name {
            color: #000;
            text-shadow: 0 0 5px rgba(255, 214, 10, 0.8);
        }

        .roulette-item.netherstar .roulette-item-name,
        .roulette-item.ender .roulette-item-name {
            color: white;
            text-shadow: 0 0 5px rgba(157, 78, 221, 0.8);
        }

        .shiny-badge {
            font-size: 0.7em;
            color: #000;
            font-weight: 700;
            background: #ffd60a;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .item-count {
            font-size: 0.8em;
            color: #98c1d9;
            margin-top: 4px;
        }

        .spin-button {
            padding: 20px 50px;
            font-size: 1.3em;
            font-weight: 600;
            background: linear-gradient(135deg, #e63946 0%, #ff006e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(230, 57, 70, 0.4);
            align-self: center;
            margin-top: 10px;
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(230, 57, 70, 0.6);
        }

        .spin-button:disabled {
            background: #2d3748;
            cursor: not-allowed;
            box-shadow: none;
        }

        .sidebar {
            display: flex;
            flex-direction:column;
            gap: 20px;
        }

        .token-display {
            background: linear-gradient(135deg, #2d3748 0%, #3d5a80 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            border: 1px solid #3d5a80;
        }

        .token-display h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .token-count {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            color: #98c1d9;
        }

        /* Login Form Styles */
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #3d5a80;
            border-radius: 10px;
            font-size: 1em;
            background: #1a1f2e;
            color: #98c1d9;
        }

        .login-input:focus {
            outline: none;
            border-color: #5a7a9a;
        }

        .login-button {
            padding: 12px;
            background: linear-gradient(135deg, #3d5a80 0%, #5a7a9a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 90, 128, 0.4);
        }

        .logout-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #e63946 0%, #b91d43 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            align-self: center;
        }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 57, 70, 0.4);
        }

        .player-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(26, 31, 46, 0.8);
            border-radius: 10px;
            border: 1px solid #3d5a80;
        }

        .player-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #98c1d9;
            margin-bottom: 5px;
            text-align: center;
        }

        .player-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
            text-align: center;
        }

        .login-error {
            color: #e63946;
            font-size: 0.9em;
            margin-top: 5px;
            text-align: center;
            display: none;
        }

        .refresh-button {
            width: 100%;
            padding: 12px;
            background: #1a1f2e;
            color: #98c1d9;
            border: 2px solid #3d5a80;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .refresh-button:hover {
            background: #3d5a80;
            color: white;
        }

        .pokemon-list {
            background: #1a1f2e;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #3d5a80;
        }

        .pokemon-list h3 {
            margin-bottom: 15px;
            color: #98c1d9;
            font-size: 1.3em;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .pokemon-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #0f1419;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.2s;
            border: 1px solid #2d3748;
            color: #98c1d9;
        }

        .pokemon-item:hover {
            transform: translateX(5px);
            border-color: #3d5a80;
        }

        .pokemon-sprite {
            width: 40px;
            height: 40px;
            image-rendering: pixelated;
        }

        .shiny-info {
            background: linear-gradient(135deg, #ffd60a 0%, #ffb703 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 214, 10, 0.3);
        }

        .result-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1f2e;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            z-index: 1000;
            text-align: center;
            min-width: 400px;
            border: 2px solid #3d5a80;
            max-width: 500px;
            width: 90%;
        }

        .result-popup.show {
            display: block;
            animation: popupAppear 0.5s ease;
        }

        .result-popup.shiny {
            background: linear-gradient(135deg, #ffd60a 0%, #ffb703 100%);
            border-color: #ffd60a;
        }

        .result-popup.netherstar {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border-color: #4cc9f0;
        }

        .result-popup.ender {
            background: linear-gradient(135deg, #7209b7 0%, #3a0ca3 100%);
            border-color: #9d4edd;
        }

        @keyframes popupAppear {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .result-popup h2 {
            color: #98c1d9;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .result-popup.shiny h2,
        .result-popup.netherstar h2,
        .result-popup.ender h2 {
            color: white;
        }

        .result-pokemon {
            margin: 20px 0;
        }

        .result-pokemon img {
            width: 120px;
            height: 120px;
            image-rendering: pixelated;
        }

        .result-pokemon-name {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 10px;
            color: #98c1d9;
        }

        .result-popup.shiny .result-pokemon-name,
        .result-popup.netherstar .result-pokemon-name,
        .result-popup.ender .result-pokemon-name {
            color: white;
        }

        .result-shiny-badge {
            display: inline-block;
            background: #000;
            color: #ffd60a;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 10px;
            animation: shimmer 2s infinite;
        }

        .result-netherstar-badge {
            display: inline-block;
            background: white;
            color: #4361ee;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 10px;
            animation: shimmer 2s infinite;
        }

        .result-ender-badge {
            display: inline-block;
            background: white;
            color: #7209b7;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 10px;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .discord-notice {
            background: linear-gradient(135deg, #e63946 0%, #b91d43 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid #ff6b6b;
            box-shadow: 0 0 15px rgba(230, 57, 70, 0.3);
        }

        .close-popup {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #3d5a80 0%, #5a7a9a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 600;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 999;
        }

        .overlay.show {
            display: block;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .pokemon-grid {
                grid-template-columns: 1fr;
            }
            
            .roulette-item {
                flex: 0 0 100px;
                height: 140px;
            }
            
            .roulette-item img {
                width: 48px;
                height: 48px;
            }
            
            .wheel-type-selector {
                flex-direction: column;
            }
            
            .result-popup {
                min-width: 300px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé∞ Cobblemon Lucky Wheel</h1>
            <p>Trade a Masterball for a Legendary Token and spin!</p>
        </div>

        <div class="main-content">
            <div class="wheel-section">
                <div class="wheel-type-selector">
                    <button class="wheel-type-btn" onclick="switchWheel('daily')">Daily Spin</button>
                    <button class="wheel-type-btn active" onclick="switchWheel('normal')">Normal Legendaries</button>
                    <button class="wheel-type-btn" onclick="switchWheel('event')">Event Legendaries</button>
                </div>

                <div class="shiny-info" id="shinyInfo">‚ú® 1% chance for SHINY! ‚ú®</div>

                <div class="roulette-container">
                    <div class="roulette-wrapper">
                        <div class="roulette-selector"></div>
                        <div class="roulette-track" id="rouletteTrack"></div>
                    </div>
                </div>

                <button class="spin-button" id="spinButton" onclick="spin()">Spin the Wheel!</button>
            </div>

            <div class="sidebar">
                <div class="token-display" id="tokenDisplay">
                    <h3>Your Legendary Tokens</h3>
                    
                    <!-- Login Form (shown when not logged in) -->
                    <div class="login-form" id="loginForm">
                        <input type="text" class="login-input" id="usernameInput" placeholder="Username" autocomplete="username">
                        <input type="password" class="login-input" id="passwordInput" placeholder="Password" autocomplete="current-password">
                        <div class="login-error" id="loginError">Invalid username or password!</div>
                        <button class="login-button" onclick="login()">Login</button>
                    </div>
                    
                    <!-- Logged in view -->
                    <div id="loggedInView" style="display: none;">
                        <div class="player-info">
                            <div class="player-name" id="playerNameDisplay">-</div>
                            <div class="player-subtitle">Logged In</div>
                        </div>
                        
                        <div class="token-count" id="normalTokenCount">-</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Normal Tokens</div>
                        <div class="token-count" id="eventTokenCount" style="font-size: 2em; margin-top: 15px;">-</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Event Tokens</div>
                        
                        <button class="logout-button" onclick="logout()">Logout</button>
                        <button class="refresh-button" onclick="loadTokenData()">üîÑ Refresh Tokens</button>
                    </div>
                </div>

                <div class="pokemon-list">
                    <h3 id="listTitle">Available Normal Legendaries</h3>
                    <div class="pokemon-grid" id="pokemonList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <h2 id="resultTitle">Congratulations! üéâ</h2>
        <div class="discord-notice">
            ‚ö†Ô∏è IMPORTANT: Send a screenshot of this win to the Discord to claim your prize!
        </div>
        <div class="result-pokemon">
            <img id="resultSprite" src="" alt="Prize">
            <div class="result-pokemon-name" id="resultName"></div>
            <div id="shinyBadge" style="display: none;" class="result-shiny-badge">‚ú® SHINY ‚ú®</div>
            <div id="netherstarBadge" style="display: none;" class="result-netherstar-badge">üåü NETHER STAR üåü</div>
            <div id="enderBadge" style="display: none;" class="result-ender-badge">üëÅÔ∏è EYES OF ENDER üëÅÔ∏è</div>
        </div>
        <button class="close-popup" onclick="closePopup()">Close</button>
    </div>

    <script>
        // Daily Spin Minecraft Items
        const dailyItems = [
            { name: 'Nether Star', id: 'nether_star', count: 1, type: 'netherstar', rarity: 'legendary' },
            { name: 'Eyes of Ender', id: 'ender_eye', count: 8, type: 'ender', rarity: 'rare' },
            { name: 'Diamond', id: 'diamond', count: 10, type: 'rare' },
            { name: 'Netherite Scrap', id: 'netherite_scrap', count: 3, type: 'rare' },
            { name: 'Iron Ingot', id: 'iron_ingot', count: 32, type: 'common' },
            { name: 'Gold Ingot', id: 'gold_ingot', count: 32, type: 'common' },
            { name: 'Emerald', id: 'emerald', count: 16, type: 'common' },
            { name: 'Lapis Lazuli', id: 'lapis_lazuli', count: 32, type: 'common' },
            { name: 'Redstone', id: 'redstone', count: 32, type: 'common' },
            { name: 'Coal', id: 'coal', count: 64, type: 'common' },
            { name: 'Experience Bottle', id: 'experience_bottle', count: 16, type: 'common' }
        ];

        // Pokemon lists
        const normalLegendaries = [
            { name: 'Zapdos', id: 145, shiny: false },
            { name: 'Moltres', id: 146, shiny: false },
            { name: 'Articuno', id: 144, shiny: false },
            { name: 'Regirock', id: 377, shiny: false },
            { name: 'Registeel', id: 379, shiny: false },
            { name: 'Regice', id: 378, shiny: false },
            { name: 'Regigigas', id: 486, shiny: false },
            { name: 'Regieleki', id: 894, shiny: false },
            { name: 'Regidrago', id: 895, shiny: false },
            { name: 'Zarude', id: 893, shiny: false },
            // Shiny only Pokemon (more common)
            { name: 'Umbreon', id: 197, shiny: true, rarity: 'common' },
            { name: 'Espeon', id: 196, shiny: true, rarity: 'common' },
            { name: 'Milotic', id: 350, shiny: true, rarity: 'common' },
            { name: 'Metagross', id: 376, shiny: true, rarity: 'common' },
            { name: 'Mismagius', id: 429, shiny: true, rarity: 'common' },
            { name: 'Gliscor', id: 472, shiny: true, rarity: 'common' },
            { name: 'Gigalith', id: 526, shiny: true, rarity: 'common' }
        ];

        const eventLegendaries = [
            { name: 'Mew', id: 151, shiny: false },
            { name: 'Mewtwo', id: 150, shiny: false },
            { name: 'Lugia', id: 249, shiny: false },
            { name: 'Ho-Oh', id: 250, shiny: false },
            { name: 'Rayquaza', id: 384, shiny: false },
            { name: 'Xerneas', id: 716, shiny: false },
            { name: 'Latias', id: 380, shiny: false },
            { name: 'Latios', id: 381, shiny: false }
        ];

        // Additional Pokemon for daily spin (non-shiny only)
        const dailyPokemon = [
            { name: 'Growlithe', id: 58, shiny: false },
            { name: 'Machop', id: 66, shiny: false },
            { name: 'Dratini', id: 147, shiny: false },
            { name: 'Ralts', id: 280, shiny: false }
        ];

        let currentWheel = 'normal';
        let spinning = false;
        let tokenData = {};
        let userAccounts = {}; // Stores username:password pairs
        let selectedPlayer = '';
        const SHINY_CHANCE = 0.01;
        const SHINY_ONLY_CHANCE = 0.10; // 10% chance for shiny-only Pokemon in normal wheel
        let rouletteItems = [];

        // Load saved login from localStorage
        function loadSavedLogin() {
            const savedUser = localStorage.getItem('wheel_logged_in_user');
            if (savedUser) {
                selectedPlayer = savedUser;
                updateLoginUI();
                loadTokenData();
            }
        }

        // Update login UI based on login state
        function updateLoginUI() {
            const loginForm = document.getElementById('loginForm');
            const loggedInView = document.getElementById('loggedInView');
            const playerNameDisplay = document.getElementById('playerNameDisplay');
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');
            const loginError = document.getElementById('loginError');
            
            if (selectedPlayer) {
                // User is logged in
                loginForm.style.display = 'none';
                loggedInView.style.display = 'block';
                playerNameDisplay.textContent = selectedPlayer;
                
                // Clear password field
                passwordInput.value = '';
                loginError.style.display = 'none';
            } else {
                // User is not logged in
                loginForm.style.display = 'flex';
                loggedInView.style.display = 'none';
                playerNameDisplay.textContent = '-';
                
                // Clear input fields
                usernameInput.value = '';
                passwordInput.value = '';
                loginError.style.display = 'none';
                
                // Reset token display
                document.getElementById('normalTokenCount').textContent = '-';
                document.getElementById('eventTokenCount').textContent = '-';
            }
        }

        // Login function
        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            const loginError = document.getElementById('loginError');
            
            if (!username || !password) {
                loginError.textContent = 'Please enter username and password!';
                loginError.style.display = 'block';
                return;
            }
            
            // Check if username exists and password matches
            if (userAccounts[username] && userAccounts[username] === password) {
                selectedPlayer = username;
                localStorage.setItem('wheel_logged_in_user', username);
                updateLoginUI();
                loadTokenData();
                loginError.style.display = 'none';
            } else {
                loginError.textContent = 'Invalid username or password!';
                loginError.style.display = 'block';
            }
        }

        // Logout function
        function logout() {
            selectedPlayer = '';
            localStorage.removeItem('wheel_logged_in_user');
            updateLoginUI();
            tokenData = {};
        }

        // Get Minecraft item sprite
        function getMinecraftSprite(id) {
            return `https://minecraftitemids.com/item/64/${id}.png`;
        }

        // Get Pokemon sprite
        function getSprite(id, shiny = false) {
            if (shiny) {
                return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
            }
            return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
        }

        // Load spins history from localStorage
        function loadSpinsHistory() {
            const history = localStorage.getItem('wheel_spins_history');
            return history ? JSON.parse(history) : {};
        }

        // Save spins history to localStorage
        function saveSpinsHistory(history) {
            localStorage.setItem('wheel_spins_history', JSON.stringify(history));
        }

        // Get remaining spins for player
        function getRemainingSpins(player, tokenType) {
            const history = loadSpinsHistory();
            const playerKey = player + (tokenType === 'event' ? '_event' : '');
            const usedSpins = history[playerKey] || 0;
            const availableTokens = tokenData[playerKey] || 0;
            
            return Math.max(0, availableTokens - usedSpins);
        }

        // Check if daily spin is available
        function canSpinDaily(player) {
            const history = loadSpinsHistory();
            const lastDailySpin = history[player + '_daily_timestamp'];
            
            if (!lastDailySpin) return true;
            
            const lastSpinDate = new Date(lastDailySpin);
            const now = new Date();
            
            // Check if 24 hours have passed
            const hoursSinceLastSpin = (now - lastSpinDate) / (1000 * 60 * 60);
            return hoursSinceLastSpin >= 24;
        }

        function createRoulette() {
            const track = document.getElementById('rouletteTrack');
            track.innerHTML = '';
            rouletteItems = [];
            
            let items;
            if (currentWheel === 'daily') {
                items = dailyItems;
            } else if (currentWheel === 'normal') {
                items = normalLegendaries;
            } else {
                items = eventLegendaries;
            }
            
            // Create enough items for a smooth spin
            for (let i = 0; i < 60; i++) {
                let item;
                
                if (currentWheel === 'daily') {
                    // For daily spin, include both Minecraft items and Pokemon
                    const allDailyItems = [...dailyItems, ...dailyPokemon];
                    item = allDailyItems[Math.floor(Math.random() * allDailyItems.length)];
                    
                    const isNetherstar = item.type === 'netherstar';
                    const isEnder = item.type === 'ender';
                    
                    rouletteItems.push({
                        ...item,
                        isShiny: false,
                        type: isNetherstar ? 'netherstar' : (isEnder ? 'ender' : 'normal'),
                        isPokemon: item.id <= 1000 // Assuming Pokemon IDs are less than 1000
                    });
                    
                    const div = document.createElement('div');
                    if (isNetherstar) {
                        div.className = 'roulette-item netherstar';
                    } else if (isEnder) {
                        div.className = 'roulette-item ender';
                    } else {
                        div.className = 'roulette-item';
                    }
                    
                    if (item.id <= 1000) { // It's a Pokemon
                        div.innerHTML = `
                            <img src="${getSprite(item.id, false)}" alt="${item.name}">
                            <div class="roulette-item-name">${item.name}</div>
                        `;
                    } else { // It's a Minecraft item
                        div.innerHTML = `
                            <img src="${getMinecraftSprite(item.id)}" alt="${item.name}">
                            <div class="roulette-item-name">${item.name}</div>
                            <div class="item-count">${item.count}x</div>
                        `;
                    }
                    track.appendChild(div);
                } else {
                    // For legendary wheels
                    item = items[Math.floor(Math.random() * items.length)];
                    
                    // Determine if shiny
                    let isShiny = false;
                    if (item.shiny === true) {
                        // This Pokemon can only be shiny
                        isShiny = true;
                    } else if (Math.random() < SHINY_CHANCE) {
                        // Regular legendary has 1% chance to be shiny
                        isShiny = true;
                    }
                    
                    rouletteItems.push({
                        pokemon: item,
                        isShiny: isShiny,
                        rarity: item.rarity || 'legendary'
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'roulette-item' + (isShiny ? ' shiny' : '');
                    div.innerHTML = `
                        <img src="${getSprite(item.id, isShiny)}" alt="${item.name}">
                        <div class="roulette-item-name">${item.name}</div>
                        ${isShiny ? '<div class="shiny-badge">SHINY</div>' : ''}
                    `;
                    track.appendChild(div);
                }
            }
            
            // Reset track position
            track.style.transform = 'translateX(0)';
        }

        function updatePokemonList() {
            const list = document.getElementById('pokemonList');
            const title = document.getElementById('listTitle');
            const shinyInfo = document.getElementById('shinyInfo');
            
            if (currentWheel === 'daily') {
                title.textContent = 'Daily Spin Rewards';
                shinyInfo.style.display = 'none';
                list.innerHTML = '';
                
                // Show Minecraft items
                dailyItems.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.className = 'pokemon-item';
                    listItem.innerHTML = `
                        <img class="pokemon-sprite" src="${getMinecraftSprite(item.id)}" alt="${item.name}">
                        <span>${item.name} (${item.count}x)</span>
                    `;
                    list.appendChild(listItem);
                });
                
                // Show Pokemon
                dailyPokemon.forEach(pokemon => {
                    const item = document.createElement('div');
                    item.className = 'pokemon-item';
                    item.innerHTML = `
                        <img class="pokemon-sprite" src="${getSprite(pokemon.id)}" alt="${pokemon.name}">
                        <span>${pokemon.name}</span>
                    `;
                    list.appendChild(item);
                });
            } else {
                const legendaries = currentWheel === 'normal' ? normalLegendaries : eventLegendaries;
                title.textContent = currentWheel === 'normal' ? 'Available Normal Legendaries' : 'Available Event Legendaries';
                shinyInfo.style.display = 'block';
                list.innerHTML = '';
                
                legendaries.forEach(pokemon => {
                    const item = document.createElement('div');
                    item.className = 'pokemon-item';
                    
                    // Check if this Pokemon is shiny-only
                    const isShinyOnly = pokemon.shiny === true;
                    
                    item.innerHTML = `
                        <img class="pokemon-sprite" src="${getSprite(pokemon.id, isShinyOnly)}" alt="${pokemon.name}">
                        <span>${pokemon.name}${isShinyOnly ? ' (Shiny)' : ''}</span>
                    `;
                    list.appendChild(item);
                });
            }
        }

        function switchWheel(type) {
            if (spinning) return;
            
            currentWheel = type;
            
            document.querySelectorAll('.wheel-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const buttons = document.querySelectorAll('.wheel-type-btn');
            if (type === 'daily') {
                buttons[0].classList.add('active');
            } else if (type === 'normal') {
                buttons[1].classList.add('active');
            } else {
                buttons[2].classList.add('active');
            }
            
            createRoulette();
            updatePokemonList();
            updateTokenDisplay();
        }

        async function loadTokenData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/freecrime/cml/refs/heads/main/coins');
                const text = await response.text();
                
                const lines = text.trim().split('\n');
                tokenData = {};
                userAccounts = {}; // Reset accounts
                
                lines.forEach(line => {
                    const match = line.match(/(\w+)\s*=\s*([^\s]+)/);
                    
                    if (match) {
                        const key = match[1];
                        const value = match[2];
                        
                        if (key.endsWith('_acc')) {
                            // This is an account entry (username: password)
                            const username = key.replace('_acc', '');
                            userAccounts[username] = value;
                        } else {
                            // This is a token count entry
                            const numValue = parseInt(value);
                            if (!isNaN(numValue)) {
                                tokenData[key] = numValue;
                            }
                        }
                    }
                });
                
                updateTokenDisplay();
            } catch (error) {
                console.error('Error loading token data:', error);
                alert('Failed to load token data. Please try again.');
            }
        }

        function updateTokenDisplay() {
            if (!selectedPlayer) return;
            
            const normalCount = document.getElementById('normalTokenCount');
            const eventCount = document.getElementById('eventTokenCount');
            
            const normalTokens = tokenData[selectedPlayer] || 0;
            const eventTokens = tokenData[selectedPlayer + '_event'] || 0;
            
            const remainingNormal = getRemainingSpins(selectedPlayer, 'normal');
            const remainingEvent = getRemainingSpins(selectedPlayer, 'event');
            
            normalCount.textContent = `${remainingNormal} / ${normalTokens}`;
            eventCount.textContent = `${remainingEvent} / ${eventTokens}`;
            
            if (remainingNormal <= 0) {
                normalCount.style.color = '#e63946';
            } else {
                normalCount.style.color = '#98c1d9';
            }
            
            if (remainingEvent <= 0) {
                eventCount.style.color = '#e63946';
            } else {
                eventCount.style.color = '#98c1d9';
            }
        }

        function spin() {
            if (spinning) return;
            
            if (!selectedPlayer) {
                alert('Please login first!');
                return;
            }
            
            // Check for daily spin
            if (currentWheel === 'daily') {
                if (!canSpinDaily(selectedPlayer)) {
                    const history = loadSpinsHistory();
                    const lastSpin = new Date(history[selectedPlayer + '_daily_timestamp']);
                    const nextSpin = new Date(lastSpin.getTime() + (24 * 60 * 60 * 1000));
                    const hoursLeft = Math.ceil((nextSpin - new Date()) / (1000 * 60 * 60));
                    alert(`Daily spin not available yet! Come back in ${hoursLeft} hours.`);
                    return;
                }
            } else {
                const tokenType = currentWheel === 'normal' ? 'normal' : 'event';
                const remainingSpins = getRemainingSpins(selectedPlayer, tokenType);
                
                if (remainingSpins <= 0) {
                    alert(`No more ${tokenType} spins remaining! You've used all available tokens.`);
                    return;
                }
            }
            
            spinning = true;
            const spinButton = document.getElementById('spinButton');
            spinButton.disabled = true;
            spinButton.textContent = 'Spinning...';
            
            const track = document.getElementById('rouletteTrack');
            
            // Calculate spin distance - simple and reliable
            const trackWidth = track.scrollWidth;
            const containerWidth = track.parentElement.offsetWidth;
            
            // Spin most of the track but not all the way
            const spinDistance = trackWidth * 0.8 + (Math.random() * 200);
            
            track.style.transform = `translateX(-${spinDistance}px)`;
            
            setTimeout(() => {
                // Figure out which item is under the selector
                const itemWidth = 120; // Width of each roulette item
                const margin = 10; // Margin between items
                const selectorPosition = containerWidth / 2;
                
                // Calculate which item index is under the selector
                const totalItemWidth = itemWidth + margin;
                const trackPosition = parseFloat(track.style.transform.replace('translateX(', '').replace('px)', '')) || 0;
                const absolutePosition = Math.abs(trackPosition);
                
                // Find which item is centered under the selector
                let winningIndex = Math.floor((absolutePosition + selectorPosition) / totalItemWidth);
                
                // Make sure index is within bounds
                winningIndex = winningIndex % rouletteItems.length;
                
                // Get the winning item from the roulette
                let winningItemData = rouletteItems[winningIndex];
                
                // Record the spin
                const history = loadSpinsHistory();
                
                if (currentWheel === 'daily') {
                    history[selectedPlayer + '_daily_timestamp'] = new Date().toISOString();
                    
                    // Store daily win
                    const dailyWins = JSON.parse(localStorage.getItem('daily_wins_history') || '{}');
                    if (!dailyWins[selectedPlayer]) dailyWins[selectedPlayer] = [];
                    
                    // Check if it's a Pokemon or Minecraft item
                    if (winningItemData.id <= 1000) { // Pokemon
                        dailyWins[selectedPlayer].push({
                            pokemon: winningItemData.name,
                            id: winningItemData.id,
                            isPokemon: true,
                            timestamp: new Date().toISOString()
                        });
                    } else { // Minecraft item
                        dailyWins[selectedPlayer].push({
                            item: winningItemData.name,
                            id: winningItemData.id,
                            count: winningItemData.count,
                            type: winningItemData.type,
                            isPokemon: false,
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    localStorage.setItem('daily_wins_history', JSON.stringify(dailyWins));
                    
                    // Show result with the actual item that landed
                    showResult(winningItemData, false);
                } else {
                    const tokenType = currentWheel === 'normal' ? 'normal' : 'event';
                    const historyKey = selectedPlayer + (tokenType === 'event' ? '_event' : '');
                    history[historyKey] = (history[historyKey] || 0) + 1;
                    
                    // Store Pokemon win
                    const winsHistory = JSON.parse(localStorage.getItem('wheel_wins_history') || '{}');
                    if (!winsHistory[selectedPlayer]) winsHistory[selectedPlayer] = [];
                    
                    winsHistory[selectedPlayer].push({
                        pokemon: winningItemData.pokemon.name,
                        id: winningItemData.pokemon.id,
                        shiny: winningItemData.isShiny,
                        type: tokenType,
                        rarity: winningItemData.rarity,
                        timestamp: new Date().toISOString()
                    });
                    
                    localStorage.setItem('wheel_wins_history', JSON.stringify(winsHistory));
                    
                    // Show result with the actual item that landed
                    showResult(winningItemData.pokemon, winningItemData.isShiny);
                }
                
                saveSpinsHistory(history);
                
                spinning = false;
                spinButton.disabled = false;
                spinButton.textContent = 'Spin the Wheel!';
                
                // Reset for next spin
                setTimeout(() => {
                    createRoulette();
                }, 500);
                
                updateTokenDisplay();
            }, 4000);
        }

        function showResult(item, isShiny) {
            const popup = document.getElementById('resultPopup');
            const title = document.getElementById('resultTitle');
            const sprite = document.getElementById('resultSprite');
            const name = document.getElementById('resultName');
            const shinyBadge = document.getElementById('shinyBadge');
            const netherstarBadge = document.getElementById('netherstarBadge');
            const enderBadge = document.getElementById('enderBadge');
            
            popup.classList.remove('shiny', 'netherstar', 'ender');
            shinyBadge.style.display = 'none';
            netherstarBadge.style.display = 'none';
            enderBadge.style.display = 'none';
            
            if (currentWheel === 'daily') {
                // Check if it's a Pokemon or Minecraft item
                if (item.id <= 1000) { // Pokemon
                    sprite.src = getSprite(item.id, false);
                    name.textContent = item.name;
                    title.textContent = 'Daily Pok√©mon! üéÅ';
                } else { // Minecraft item
                    sprite.src = getMinecraftSprite(item.id);
                    
                    if (item.type === 'netherstar') {
                        name.textContent = `${item.name} (${item.count}x)`;
                        popup.classList.add('netherstar');
                        title.textContent = 'üåü NETHER STAR! üåü';
                        netherstarBadge.style.display = 'block';
                    } else if (item.type === 'ender') {
                        name.textContent = `${item.name} (${item.count}x)`;
                        popup.classList.add('ender');
                        title.textContent = 'üëÅÔ∏è EYES OF ENDER! üëÅÔ∏è';
                        enderBadge.style.display = 'block';
                    } else {
                        name.textContent = `${item.name} (${item.count}x)`;
                        title.textContent = 'Daily Reward! üéÅ';
                    }
                }
            } else {
                sprite.src = getSprite(item.id, isShiny);
                name.textContent = item.name;
                
                if (isShiny) {
                    popup.classList.add('shiny');
                    title.textContent = 'üåü SHINY POK√âMON! üåü';
                    shinyBadge.style.display = 'block';
                } else {
                    title.textContent = 'Congratulations! üéâ';
                }
            }
            
            popup.classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        function closePopup() {
            document.getElementById('resultPopup').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        // Initialize
        createRoulette();
        updatePokemonList();
        loadSavedLogin(); // Load saved login if exists
        loadTokenData();
    </script>
</body>
</html>
